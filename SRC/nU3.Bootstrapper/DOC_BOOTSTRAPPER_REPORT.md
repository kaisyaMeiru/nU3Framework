# nU3 Bootstrapper 기능 요약 및 상세 (보고서)

작성 목적
- `nU3.Bootstrapper` 프로젝트가 애플리케이션 실행 전 수행하는 핵심 책임과 동작 흐름을 문서화하여 운영/개발 담당자가 시스템 동작을 이해하고 유지보수할 수 있도록 정리합니다.

대상 파일
- `SRC\nU3.Bootstrapper\Program.cs`의 초기화 및 업데이트 로직에 기반하여 작성되었습니다.

---

## 1. 시스템 초기화 및 환경 설정 (System Bootstrapping)

목적
- 애플리케이션이 실행되기 위한 최소 기반 환경을 준비하고, 외부(서버)와의 연결 가능 여부를 확인합니다.

주요 작업
- 설정 로드
  - 우선순위: 실행 디렉토리의 `appsettings.json` → 실행 파일의 임베디드 리소스(내장) → 기본값
  - 사용 항목 예시
    - `ServerConnection:BaseUrl` ? 서버 API 기본 주소
    - `RuntimeDirectory` (있을 경우) ? 모듈 설치/실행 기준 경로
  - 리소스 로드 실패 시 임시 파일을 만들어 ConfigurationBuilder로 로드하는 안전 장치를 둠.

- 네트워크(DB) 연결 확인
  - `IDBAccessService` (여기서는 `HttpDBAccessClient`)로 서버의 DB 서비스 접속 시도
  - 연결 성공 여부에 따라 로그로 상태를 남기고, 실패 시에도 부트스트랩 흐름은 정책에 따라 계속 진행하거나 중단할 수 있음(현 코드는 계속 진행).

- 실행 파일 위치 탐색(FindShellPath)
  - 배포 경로, 개발 빌드 경로(프로젝트의 bin/Debug 등), 상위 디렉토리 전체 검색을 순차적으로 시도
  - 찾지 못하면 사용자에게 경고 메시지 출력 및 종료

운영/개발 시 고려사항
- 프로덕션에서는 `appsettings.json`에 서버 주소 및 인증 설정을 정확히 명시하고, Bootstrapper는 이를 검증하여 실패 시 운영자 알림을 권장합니다.

---

## 2. 프레임워크 컴포넌트 자동 업데이트 (Framework Patching)

목적
- 런타임에 필요한 DLL/컴포넌트가 최신인지 검사하고, 필요 시 서버에서 내려받아 설치하여 무결성과 가용성을 보장합니다.

주요 흐름
- 버전 비교
  - `ComponentLoader`가 서버(또는 로컬 메타데이터)의 `SYS_COMPONENT_MST` / `SYS_COMPONENT_VER` 정보를 조회
  - 로컬 파일의 해시(예: SHA256)와 서버에 등록된 해시를 비교

- 캐시 기반 다운로드
  - 업데이트 대상 발견 시 `HttpFileTransferClient` 등을 사용해 파일을 임시 캐시 경로(예: `%AppData%\nU3.Framework\Cache\Components`)로 다운로드
  - 다운로드 실패/충돌에 대한 재시도 정책 적용

- 패치 및 설치
  - 캐시에서 실제 설치 경로(RuntimeDirectory)에 파일을 복사
  - 파일 잠금(사용 중) 문제 발생 시 재시도 로직을 통해 안정적으로 덮어쓰기
  - 설치 완료 후 로그 기록 및 필요 시 모듈 메타데이터 갱신

UI 연동
- 업데이트 진행은 `UpdateProgressForm`을 통해 사용자에게 표시
- 업데이트 실패 시 필수 컴포넌트 검사 후, 미설치 항목이 존재하면 실행 차단 및 경고

운영/보안 권고
- 패치 파일 검증: 전송 중 무결성 검사를 위해 서버에서 해시/서명 정보를 제공하고, 클라이언트는 다운로드 후 검증해야 합니다.
- 롤백 전략: 실패 시 이전 정상 버전으로 롤백할 수 있는 정책 고려.

---

## 3. 화면 모듈 동기화 (Module Synchronization)

목적
- 메인 쉘에서 즉시 사용할 화면 모듈(화면 DLL)을 최신 상태로 유지하여 런타임 오류를 방지합니다.

동작
- `ModuleLoader`가 모듈 메타데이터(프로그램 목록, 모듈별 활성 버전)를 확인
- 서버 사용 시 HTTP 통해 모듈 파일을 내려받거나, 로컬 캐시를 사용하여 설치 경로에 배치
- 모듈 설치 후 메타데이터(예: `SYS_PROG_MST`)를 갱신하여 Shell이 올바르게 모듈을 로드하도록 준비

주의
- 모듈 로드 시점에 파일이 사용 중이면 로드 실패 가능성 존재 → Bootstrapper 단계에서 패치 완료를 보장해야 함

---

## 4. 사용자 인터페이스 제공 (Update UI)

목적
- 업데이트 과정의 상태를 시각적으로 표출하여 사용자가 진행 상황을 이해할 수 있도록 합니다.

구성요소
- `UpdateProgressForm`
  - 업데이트 목록(컴포넌트명, 버전, 상태)
  - 개별 컴포넌트의 다운로드/설치 진행률
  - 성공/실패 상태 표시

행동
- 백그라운드 작업으로 업데이트를 수행하고 UI는 이벤트 기반으로 진행률을 갱신
- 모든 업데이트 완료 후 결과 요약을 표시

운영 정책
- 필수 컴포넌트(Required)가 미설치일 때는 사용자의 확인 없이 시스템 실행을 차단

---

## 5. 메인 애플리케이션 실행 (Launch Shell)

작업
- 필요한 모든 준비(설정 로드, DB 연결 확인, 컴포넌트 설치, 모듈 동기화)가 완료되면 `nU3.MainShell.exe` 또는 `nU3.Shell.exe`를 새로운 프로세스로 실행
- Bootstrapper는 작업을 마치고 종료될 수 있음(현재는 단순히 프로세스를 시작)

디버그 전용
- `#if DEBUG` 블록에서 `Seeder`를 사용하여 개발/테스트용 더미 데이터를 서버 DB에 주입(선택적)

---

## 구성 키(주요 appsettings 항목)
- `ServerConnection:BaseUrl` ? 서버 API 기본 주소
- `ServerSettings:Database:Provider` ? 서버 측 DB 공급자 (서버 설정 쪽 예시)
- `ServerSettings:Database:Connections:Sqlite` ? SQLite 연결 문자열(서버에서 사용하는 키 예시)
- `RuntimeDirectory` ? 모듈 설치/실행 디렉토리(선택)

---

## 운영/보안 권장사항
1. 인증/암호화
   - 서버 API 통신(특히 파일 전송/업데이트)는 TLS(HTTPS)로 보호
   - 인증 토큰(예: JWT) 사용 권장

2. 무결성 검사
   - 서버에서 제공하는 해시 또는 서명으로 다운로드 파일을 검증

3. 롤백/트랜잭션
   - 패치 중 실패한 경우를 대비한 롤백 프로세스 도입

4. 마이그레이션
   - 스키마 변경은 마이그레이션 도구(예: Flyway, EF Migrations)로 관리

5. 로그/모니터링
   - 업데이트/패치 로그를 중앙 로깅 시스템으로 전송하여 상태 추적

---

## 결론
`nU3.Bootstrapper`는 실행 전 점검과 자동 업데이트, 모듈 동기화를 통해 메인 애플리케이션의 안정성과 무결성을 확보하는 역할을 담당합니다. 운영 환경에서는 보안(HTTPS, 서명 검증), 마이그레이션 정책, 롤백 전략을 보완하여 안정화하는 것을 권장합니다.


*문서 생성: BOOTSTRAPPER_REPORT.md (UTF-8)*
