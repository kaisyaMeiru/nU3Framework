# 배포 및 분배 마스터 문서 (Deployment & Distribution Master Document)

**버전:** 1.0 (통합본)
**날짜:** 2026-02-10
**컨텍스트:** nU3.Framework (부트스트래퍼, 배포 도구, 업데이트 전략)

---

## 1. 개요

배포 시스템은 클라이언트가 파일 잠금 문제없이 항상 최신 버전의 프레임워크와 모듈을 실행하도록 보장합니다. **Bootstrapper** (클라이언트 측 업데이터)와 **Deployer** (관리자 도구)로 구성됩니다.

---

## 2. 부트스트래퍼 워크플로우 (`nU3.Bootstrapper`)

부트스트래퍼는 실행 파일의 진입점입니다.

### 2.1 핵심 로직 (`CheckAndLoadModules`)
1.  **초기화:** 로컬 DB(`nU3_Local.db`) 및 설정 로드.
2.  **버전 확인:** 로컬 `SYS_MODULE_VER`와 서버 비교.
3.  **단계적 배포 ("섀도우 카피" 전략):**
    *   **Step 1: 캐시로 다운로드**
        *   경로: `%AppData%\nU3.Framework\Cache\[SubSystem]\[FileName]`
        *   동작: `HttpFileTransferClient`를 통해 파일 다운로드.
        *   이점: 파일 잠금 없음, 백그라운드 다운로드 가능.
    *   **Step 2: 런타임으로 설치**
        *   경로: `[ExeDirectory]\Modules\[SubSystem]\[FileName]`
        *   동작: 쉘이 시작되기 *전*에 캐시에서 런타임으로 복사.
        *   이점: 런타임 일관성 보장.
4.  **실행:** `nU3.Shell.exe` 실행.

### 2.2 프레임워크 컴포넌트 패치
*   프레임워크 코어(DLL, EXE)도 유사한 단계적 접근 방식을 따르지만 **InstallPath**를 지원합니다.
*   **InstallPath**: 상대 경로 지원 (예: `plugins/`, `resources/images/`).

---

## 3. 배포 도구 (`nU3.Tools.Deployer`)

모듈, 메뉴 및 버전을 관리하기 위한 관리자 도구입니다.

### 3.1 주요 기능
*   **프로그램 모듈 배포:**
    *   **스마트 업로드:** DLL에서 `[nU3ProgramInfo]`를 자동 스캔하여 ModuleID, ProgID, Version 등록.
    *   **일괄 업로드:** 전체 폴더 스캔.
*   **프레임워크 배포:**
    *   코어 DLL 및 타사 라이브러리 관리.
    *   `InstallPath` (클라이언트 상의 상대 경로) 구성.
    *   `Priority` 및 `Required` 플래그 설정.
*   **메뉴 관리:**
    *   `SYS_MENU`를 위한 트리 기반 편집기.
    *   메뉴와 프로그램 매핑.

### 3.2 InstallPath 구성
*   **루트:** `""` (예: `nU3.Core.dll`)
*   **서브폴더:** `"plugins"` (예: `MyPlugin.dll`)
*   **중첩:** `"resources\images"` (예: `logo.png`)
*   **참고:** 경로는 애플리케이션 실행 디렉토리에 상대적입니다.

---

## 4. 어셈블리 로딩 전략

### 4.1 도전 과제
*   **파일 잠금:** Windows는 로드된 DLL을 잠급니다.
*   **의존성 주입:** 경계를 넘어 타입이 일치해야 합니다.
*   **핫 배포:** 실행 중 업데이트(제한적 지원) 또는 재시작 필요.

### 4.2 해결책: `LoadFrom` + 스테이징
*   **로딩:** `EventBus`의 타입 동일성과 DI 컨테이너 호환성을 보장하기 위해 `Assembly.LoadFrom`을 사용합니다 (`LoadFile`이나 복잡한 `ALC` 격리 대신).
*   **업데이트:**
    *   런타임: 업데이트 시 재시작 필요 (부트스트래퍼가 처리).
    *   핫 배포 (개념적): 현재 도메인에 *새* 모듈을 로드할 수 있지만, *기존* 타입을 업데이트하려면 .NET의 타입 동일성 문제로 인해 보통 재시작이 필요합니다.
    *   **현재 구현:** 부트스트래퍼가 쉘 실행 *전*에 업데이트를 처리합니다.

---

## 5. 보안 및 검증

*   **무결성:** 모든 다운로드에 대해 SHA256 해시 검증.
*   **권한 부여:** 서버 연결 시 유효한 JWT 필요 (설정된 경우).
*   **폴백:** 서버 도달 불가 시 로컬 DB를 통해 오프라인 모드 허용 (읽기 전용).

---

## 6. 구현 상태 (Phase 3)

*   **완료됨:**
    *   부트스트래퍼 단계적 배포 로직.
    *   배포 도구 스마트 업로드 및 메뉴 편집기.
    *   프레임워크 컴포넌트에 대한 InstallPath 지원.
    *   연결성 통합 (`HttpDBAccessClient` 사용).

*   **다음 단계:**
    *   차분 업데이트 (바이너리 델타).
    *   백그라운드 다운로더 서비스.